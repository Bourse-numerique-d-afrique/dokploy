version: '3.8'

services:
  exchange:
    image: ghcr.io/bourse-numerique-d-afrique/server:${VERSION:-latest}
    pull_policy: always
    restart: unless-stopped
    ports:
      - 5700
    environment:
      - POSTGRES_HOST=timescaledb
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - GQL_SERVER_PORT=5700
      - GQL_HOST=0.0.0.0
      - HOST=0.0.0.0
      - GQL_PORT=5700
      - TOKEN_ISSUER=${TOKEN_ISSUER}
      - JWT_SECRET=${JWT_SECRET}
      - ETH_CLIENT_URL=http://ethereum:8545
      - ETH_PRIVATE_KEY=${ETH_PRIVATE_KEY}
      - ETH_ADMIN_ADDRESS=${ETH_ADMIN_ADDRESS}
      - ETH_HA_STRATEGY=Priority
      - ETH_SIGNATURE_PARALLELISM=3
      - MTN_URL=${MTN_URL}
      - MTN_COLLECTION_PRIMARY_KEY=${MTN_COLLECTION_PRIMARY_KEY}
      - MTN_COLLECTION_SECONDARY_KEY=${MTN_COLLECTION_SECONDARY_KEY}
      - MTN_DISBURSEMENT_PRIMARY_KEY=${MTN_DISBURSEMENT_PRIMARY_KEY}
      - MTN_DISBURSEMENT_SECONDARY_KEY=${MTN_DISBURSEMENT_SECONDARY_KEY}
      - MTN_WEBHOOK_HOST=${MTN_WEBHOOK_HOST}
      - MTN_SERVER_CALLBACK_PORT=5705
      - AIRTEL_CLIENT_ID=${AIRTEL_CLIENT_ID}
      - AIRTEL_CLIENT_SECRET=${AIRTEL_CLIENT_SECRET}
      - AIRTEL_ENVIRONMENT=${AIRTEL_ENVIRONMENT}
      - AIRTEL_CALLBACK_URL=${AIRTEL_CALLBACK_URL}
      - AIRTEL_DISBURSEMENT_PIN=${AIRTEL_DISBURSEMENT_PIN}
      - AIRTEL_SERVER_CALLBACK_PORT=5706
      - PROMETHEUS_PORT=9090
      - PROMETHEUS_ENABLED=false
      - REDIS_URL=redis://redis:6379
      - ADMIN_EMAIL="pondonda1@gmail.com"
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_FIRST_NAME=${ADMIN_FIRST_NAME:-"Pascal"}
      - ADMIN_LAST_NAME=${ADMIN_LAST_NAME:-"Ondo"}
      - ADMIN_PHONE=${ADMIN_PHONE:-"+24107457613"}
      - ADMIN_PINCODE=${ADMIN_PINCODE:-"1234"}
    depends_on:
      - timescaledb
      - ethereum
      - redis
    networks:
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.bna-exchange-secure.rule=Host(`api.boursenumeriquedafrique.com`)
      - traefik.http.routers.bna-exchange-secure.entrypoints=websecure
      - traefik.http.routers.bna-exchange-secure.priority=100
      - traefik.http.routers.bna-exchange-secure.tls=true
      - traefik.http.routers.bna-exchange-secure.tls.certresolver=letsencrypt
      - traefik.http.routers.bna-exchange-secure.service=bna-exchange-svc
      - traefik.http.services.bna-exchange-svc.loadbalancer.server.port=5700

  clearing-house:
    image: ghcr.io/bourse-numerique-d-afrique/server-clearing-house:${VERSION:-latest}
    pull_policy: always
    restart: unless-stopped
    ports:
      - 8500
      - 5705
      - 5706
    environment:
      - POSTGRES_HOST=timescaledb
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - GQL_SERVER_PORT=8500
      - GQL_HOST=0.0.0.0
      - HOST=0.0.0.0
      - ROCKET_ADDRESS=0.0.0.0
      - SERVER_HOST=0.0.0.0
      - ADDRESS=0.0.0.0
      - BIND=0.0.0.0
      - GQL_PORT=8500
      - TOKEN_ISSUER=${TOKEN_ISSUER}
      - JWT_SECRET=${JWT_SECRET}
      - ETHEREUM_RPC_URL=http://ethereum:8545
      - MTN_URL=${MTN_URL}
      - MTN_COLLECTION_PRIMARY_KEY=${MTN_COLLECTION_PRIMARY_KEY}
      - MTN_COLLECTION_SECONDARY_KEY=${MTN_COLLECTION_SECONDARY_KEY}
      - MTN_DISBURSEMENT_PRIMARY_KEY=${MTN_DISBURSEMENT_PRIMARY_KEY}
      - MTN_DISBURSEMENT_SECONDARY_KEY=${MTN_DISBURSEMENT_SECONDARY_KEY}
      - MTN_WEBHOOK_HOST=${MTN_WEBHOOK_HOST}
      - MTN_SERVER_CALLBACK_PORT=5705
      - AIRTEL_CLIENT_ID=${AIRTEL_CLIENT_ID}
      - AIRTEL_CLIENT_SECRET=${AIRTEL_CLIENT_SECRET}
      - AIRTEL_ENVIRONMENT=${AIRTEL_ENVIRONMENT}
      - AIRTEL_CALLBACK_URL=${AIRTEL_CALLBACK_URL}
      - AIRTEL_DISBURSEMENT_PIN=${AIRTEL_DISBURSEMENT_PIN}
      - AIRTEL_SERVER_CALLBACK_PORT=5706
      - PROMETHEUS_ENABLED=false
    depends_on:
      - timescaledb
    volumes:
      - ./start_clearing.sh:/usr/local/bin/start_clearing.sh
    user: root
    entrypoint: ["/bin/bash", "/usr/local/bin/start_clearing.sh"]
    networks:
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      - traefik.http.routers.bna-clearing-secure.rule=Host(`payments.boursenumeriquedafrique.com`)
      - traefik.http.routers.bna-clearing-secure.entrypoints=websecure
      - traefik.http.routers.bna-clearing-secure.priority=100
      - traefik.http.routers.bna-clearing-secure.tls=true
      - traefik.http.routers.bna-clearing-secure.tls.certresolver=letsencrypt
      - traefik.http.routers.bna-clearing-secure.service=bna-clearing-svc
      - traefik.http.services.bna-clearing-svc.loadbalancer.server.port=8501

  frontend:
    image: ghcr.io/bourse-numerique-d-afrique/client:${VERSION:-latest}
    pull_policy: always
    restart: unless-stopped
    ports:
      - 80
    environment:
      - ENVIRONMENT=production
      - VITE_APP_SERVER_GRAPHQL_URL=${VITE_APP_SERVER_GRAPHQL_URL:-https://api.boursenumeriquedafrique.com/graphql}
      - VITE_SERVER_GRAPHQL_WS_URL=${VITE_SERVER_GRAPHQL_WS_URL:-wss://api.boursenumeriquedafrique.com/graphql/ws}
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.docker.network=dokploy-network
      # HTTPS router for main domain - using specific names to avoid collision
      - traefik.http.routers.bna-frontend-secure.rule=Host(`boursenumeriquedafrique.com`) || Host(`www.boursenumeriquedafrique.com`)
      - traefik.http.routers.bna-frontend-secure.entrypoints=websecure
      - traefik.http.routers.bna-frontend-secure.tls=true
      - traefik.http.routers.bna-frontend-secure.tls.certresolver=letsencrypt
      - traefik.http.routers.bna-frontend-secure.service=bna-frontend-svc
      # HTTP router for redirect
      - traefik.http.routers.bna-frontend-http.rule=Host(`boursenumeriquedafrique.com`) || Host(`www.boursenumeriquedafrique.com`)
      - traefik.http.routers.bna-frontend-http.entrypoints=web
      - traefik.http.routers.bna-frontend-http.middlewares=https-redirect
      - traefik.http.routers.bna-frontend-http.service=bna-frontend-svc
      # HTTPS redirect middleware
      - traefik.http.middlewares.https-redirect.redirectscheme.scheme=https
      - traefik.http.middlewares.https-redirect.redirectscheme.permanent=true
      # Service definition
      - traefik.http.services.bna-frontend-svc.loadbalancer.server.port=80

  timescaledb:
    image: timescale/timescaledb-ha:pg17
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - TIMESCALEDB_TELEMETRY=off
    ports:
      - 5432
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
    networks:
      - dokploy-network

  ethereum:
    image: ethereum/client-go:v1.12.0
    restart: unless-stopped
    ports:
      - 8545
      - 8546
    environment:
      - ETH_PRIVATE_KEY=${ETH_PRIVATE_KEY}
      - ETH_ADMIN_ADDRESS=${ETH_ADMIN_ADDRESS}
    volumes:
      - ethereum-data:/root/.ethereum
      - ./genesis.json:/root/genesis.json
      - ./start_geth.sh:/root/start_geth.sh
    networks:
      - dokploy-network
    entrypoint: ["/bin/sh", "/root/start_geth.sh"]

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - 6379
    command: redis-server --appendonly yes --maxmemory 128mb --maxmemory-policy allkeys-lru
    volumes:
      - redis-data:/data
    networks:
      - dokploy-network

networks:
  dokploy-network:
    external: true

volumes:
  timescaledb-data:
  ethereum-data:
  redis-data:
