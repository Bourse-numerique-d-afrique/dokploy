version: '3.8'

services:
  exchange:
    image: ghcr.io/bourse-numerique-d-afrique/server:${VERSION:-latest}
    restart: unless-stopped
    ports:
      - 5700
      - 9090
    environment:
      - POSTGRES_HOST=timescaledb
      - POSTGRES_PORT=5432
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DATABASE=${POSTGRES_DATABASE}
      - GQL_SERVER_PORT=5700
      - GQL_HOST=0.0.0.0
      - GQL_PORT=5700
      - TOKEN_ISSUER=${TOKEN_ISSUER}
      - JWT_SECRET=${JWT_SECRET}
      - ETH_CLIENT_URL=${ETH_CLIENT_URL:-http://ethereum:8545}
      - ETH_PRIVATE_KEY=${ETH_PRIVATE_KEY}
      - ETH_ADMIN_ADDRESS=${ETH_ADMIN_ADDRESS}
      - ETH_HA_STRATEGY=${ETH_HA_STRATEGY:-Priority}
      - ETH_SIGNATURE_PARALLELISM=${ETH_SIGNATURE_PARALLELISM:-3}
      - MTN_URL=${MTN_URL}
      - MTN_COLLECTION_PRIMARY_KEY=${MTN_COLLECTION_PRIMARY_KEY}
      - MTN_COLLECTION_SECONDARY_KEY=${MTN_COLLECTION_SECONDARY_KEY}
      - MTN_DISBURSEMENT_PRIMARY_KEY=${MTN_DISBURSEMENT_PRIMARY_KEY}
      - MTN_DISBURSEMENT_SECONDARY_KEY=${MTN_DISBURSEMENT_SECONDARY_KEY}
      - MTN_WEBHOOK_HOST=${MTN_WEBHOOK_HOST}
      - MTN_SERVER_CALLBACK_PORT=5705
      - AIRTEL_CLIENT_ID=${AIRTEL_CLIENT_ID}
      - AIRTEL_CLIENT_SECRET=${AIRTEL_CLIENT_SECRET}
      - AIRTEL_ENVIRONMENT=${AIRTEL_ENVIRONMENT}
      - AIRTEL_CALLBACK_URL=${AIRTEL_CALLBACK_URL}
      - AIRTEL_DISBURSEMENT_PIN=${AIRTEL_DISBURSEMENT_PIN}
      - AIRTEL_SERVER_CALLBACK_PORT=5706
      - PROMETHEUS_PORT=9090
      - PROMETHEUS_ENABLED=${PROMETHEUS_ENABLED:-true}
      - REDIS_URL=redis://redis:6379
    depends_on:
      - timescaledb
      - ethereum
      - redis
    networks:
      - dokploy-network
    labels:
      - traefik.enable=true
      - traefik.http.routers.exchange-prod.rule=Host(`api.boursenumeriquedafrique.com`)
      - traefik.http.routers.exchange-prod.entrypoints=websecure
      - traefik.http.routers.exchange-prod.tls.certResolver=letsencrypt
      - traefik.http.services.exchange-prod.loadbalancer.server.port=5700

  timescaledb:
    image: timescale/timescaledb-ha:pg17
    restart: unless-stopped
    environment:
      - POSTGRES_USER=${POSTGRES_USER}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
      - POSTGRES_DB=${POSTGRES_DATABASE}
      - TIMESCALEDB_TELEMETRY=off
    ports:
      - 5432
    volumes:
      - timescaledb-data:/var/lib/postgresql/data
    networks:
      - dokploy-network
    command:
      - postgres
      - -c
      - max_connections=200
      - -c
      - shared_buffers=256MB
      - -c
      - effective_cache_size=1GB
      - -c
      - maintenance_work_mem=128MB
      - -c
      - checkpoint_completion_target=0.9
      - -c
      - wal_buffers=16MB
      - -c
      - default_statistics_target=100
      - -c
      - random_page_cost=1.1
      - -c
      - effective_io_concurrency=200
      - -c
      - work_mem=2621kB
      - -c
      - min_wal_size=1GB
      - -c
      - max_wal_size=4GB

  ethereum:
    image: ${ETHEREUM_IMAGE:-ethereum/client-go:stable}
    restart: unless-stopped
    ports:
      - 8545
      - 8546
    volumes:
      - ethereum-data:/root/.ethereum
    networks:
      - dokploy-network
    command:
      - --http
      - --http.addr=0.0.0.0
      - --http.port=8545
      - --http.api=eth,net,web3,personal
      - --http.corsdomain=*
      - --ws
      - --ws.addr=0.0.0.0
      - --ws.port=8546
      - --ws.api=eth,net,web3
      - --ws.origins=*
      - --syncmode=snap
      - --gcmode=archive

  redis:
    image: redis:7-alpine
    restart: unless-stopped
    ports:
      - 6379
    volumes:
      - redis-data:/data
    networks:
      - dokploy-network
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

  prometheus:
    image: prom/prometheus:latest
    restart: unless-stopped
    ports:
      - 9091
    volumes:
      - ./prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus-data:/prometheus
    networks:
      - dokploy-network
    command:
      - --config.file=/etc/prometheus/prometheus.yml
      - --storage.tsdb.path=/prometheus
      - --web.console.libraries=/etc/prometheus/console_libraries
      - --web.console.templates=/etc/prometheus/consoles
      - --storage.tsdb.retention.time=30d
      - --web.enable-lifecycle
    profiles:
      - monitoring

networks:
  dokploy-network:
    external: true

volumes:
  timescaledb-data:
  ethereum-data:
  redis-data:
  prometheus-data:
